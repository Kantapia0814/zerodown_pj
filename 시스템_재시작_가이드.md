# ğŸš€ Zero-Downtime ë°°í¬ ì‹œìŠ¤í…œ ì¬ì‹œì‘ ê°€ì´ë“œ

ì»´í“¨í„° ì¬ë¶€íŒ… í›„ ì „ì²´ ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œìŠ¤í…œì„ ë‹¤ì‹œ ì‹œì‘í•˜ëŠ” ì™„ì „í•œ ë‹¨ê³„ë³„ ê°€ì´ë“œì…ë‹ˆë‹¤.

## ğŸ“‹ **ì‹œìŠ¤í…œ êµ¬ì„± ìš”ì†Œ**

- **Docker**: ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„
- **Consul**: ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬ & KV ìŠ¤í† ì–´
- **Nomad**: ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ í”Œë«í¼
- **Nginx**: Load Balancer & API Gateway
- **nginx-auto-reload**: ë™ì  ë¼ìš°íŒ… ìë™í™”
- **hello-service**: ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ (v1, v2, v3, v4...)

---

## ğŸ”§ **1ë‹¨ê³„: ê¸°ë³¸ í™˜ê²½ ì¤€ë¹„**

### **1-1. Docker Desktop ì‹¤í–‰**
```bash
# Windows/Mac: Docker Desktop ì•± ì‹¤í–‰ í›„ ì™„ì „íˆ ë¡œë”©ë  ë•Œê¹Œì§€ ëŒ€ê¸°

# ìƒíƒœ í™•ì¸
docker --version
docker ps

# ê²°ê³¼ ì˜ˆì‹œ:
# CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
```

### **1-2. ë„¤íŠ¸ì›Œí¬ IP í™•ì¸**
```bash
# IP ì£¼ì†Œ í™•ì¸ (Linux/WSL)
ip addr show

# ë˜ëŠ” (Windows)
ipconfig

# ì£¼ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ì˜ IP ì£¼ì†Œ ê¸°ë¡
# ì˜ˆì‹œ: eth0 -> 172.17.187.181
# ì´ IPë¥¼ ì´í›„ ë‹¨ê³„ì—ì„œ ì‚¬ìš©
```

---

## ğŸ—ï¸ **2ë‹¨ê³„: ì¸í”„ë¼ ì„œë¹„ìŠ¤ ì‹œì‘**

### **2-1. Consul ì„œë²„ ì‹œì‘** 
```bash
# í„°ë¯¸ë„ 1 (Consul ì „ìš©)
consul agent -dev -bind=172.17.187.181 -client=0.0.0.0

# ì‹¤í–‰ í›„ ë‹¤ìŒê³¼ ê°™ì€ ë©”ì‹œì§€ í™•ì¸:
# ==> Consul agent running!
# ==> Log data will now stream in as it occurs:
```

```bash
# í™•ì¸ (ë³„ë„ í„°ë¯¸ë„ì—ì„œ)
curl http://localhost:8500/v1/status/leader

# ì •ìƒ ê²°ê³¼: "172.17.187.181:8300"
```

### **2-2. Nomad ì„œë²„ ì‹œì‘**
```bash
# í„°ë¯¸ë„ 2 (Nomad ì „ìš©) 
nomad agent -dev -bind=172.17.187.181

# ì‹¤í–‰ í›„ ë‹¤ìŒê³¼ ê°™ì€ ë©”ì‹œì§€ í™•ì¸:
# ==> Nomad agent started! Log data will stream in below:
# ==> Nomad agent configuration:
```

### **2-3. Nomad CLI í™˜ê²½ë³€ìˆ˜ ì„¤ì •**
```bash
# Nomad CLIê°€ ì˜¬ë°”ë¥¸ ì„œë²„ì— ì—°ê²°í•˜ë„ë¡ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
export NOMAD_ADDR="http://172.17.187.181:4646"
```

```bash
# í™•ì¸ (ë³„ë„ í„°ë¯¸ë„ì—ì„œ)
nomad status
curl http://localhost:4646/v1/status/leader

# ì •ìƒ ê²°ê³¼: "172.17.187.181:4647"
```

---

## ğŸ¯ **3ë‹¨ê³„: Load Balancer ì„¤ì •**

### **3-1. Nginx ìƒíƒœ í™•ì¸ ë° ì‹œì‘**
```bash
# nginx ìƒíƒœ í™•ì¸
sudo systemctl status nginx

# nginx ì‹œì‘ (ì¤‘ì§€ëœ ê²½ìš°)
sudo systemctl start nginx

# ë¶€íŒ… ì‹œ ìë™ ì‹œì‘ ì„¤ì •
sudo systemctl enable nginx
```

### **3-2. Nginx ì„¤ì • íŒŒì¼ ë¬¸ì œ í•´ê²°**
```bash
# í˜„ì¬ ì„¤ì • íŒŒì¼ í™•ì¸
cat /etc/nginx/conf.d/hello-service.conf

# upstream ë¸”ë¡ì´ ë¹„ì–´ìˆëŠ” ê²½ìš° ì„ì‹œ ì„œë²„ ì¶”ê°€
sudo sed -i 's/upstream hello_backend {/upstream hello_backend {\n    server 127.0.0.1:8081;/' /etc/nginx/conf.d/hello-service.conf
sudo sed -i 's/upstream hello_backend_standby {/upstream hello_backend_standby {\n    server 127.0.0.1:8082;/' /etc/nginx/conf.d/hello-service.conf

# Nginx ì¬ì‹œì‘
sudo systemctl start nginx

# ì„¤ì • í™•ì¸
sudo nginx -t
```

### **3-2. consul-template ì‹¤í–‰**
```bash
# consul-template ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
consul-template \
  -template="nginx-configs/hello-service.ctmpl:/etc/nginx/conf.d/hello-service.conf:echo 'Config updated'" \
  -consul-addr="127.0.0.1:8500" &

# ë˜ëŠ” ë³„ë„ í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰
# í„°ë¯¸ë„ 3 (consul-template ì „ìš©)
consul-template \
  -template="nginx-configs/hello-service.ctmpl:/etc/nginx/conf.d/hello-service.conf:echo 'Config updated'" \
  -consul-addr="127.0.0.1:8500"
```

### **3-3. nginx-auto-reload.sh ì‹¤í–‰**
```bash
# nginx ìë™ ë¦¬ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
./nginx-auto-reload.sh &

# ë˜ëŠ” ë³„ë„ í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰
# í„°ë¯¸ë„ 4 (nginx-auto-reload ì „ìš©)
./nginx-auto-reload.sh
```

---

## ğŸš¢ **4ë‹¨ê³„: ì„œë¹„ìŠ¤ ë°°í¬**

### **4-1. hello-service ë°°í¬**
```bash
# Nomad CLIê°€ ì˜¬ë°”ë¥¸ ì„œë²„ì— ì—°ê²°í•˜ë„ë¡ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
export NOMAD_ADDR="http://172.17.187.181:4646"

# í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸
cd /mnt/c/Users/hongs/IdeaProjects/kantapia_pj

# nomad íŒŒì¼ ìƒíƒœ í™•ì¸
cat hello-service-dynamic.nomad | grep -E "(image|tags|version)" 

# nomad íŒŒì¼ ë°°í¬
nomad job run hello-service-dynamic.nomad

# ë°°í¬ í™•ì¸
nomad status hello-service-dynamic
```

### **4-2. ì„œë¹„ìŠ¤ ë“±ë¡ ëŒ€ê¸° (ì¤‘ìš”!)**
```bash
# ì„œë¹„ìŠ¤ê°€ Consulì— ë“±ë¡ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ì•½ 30ì´ˆ-1ë¶„)
echo "ì„œë¹„ìŠ¤ ë“±ë¡ ëŒ€ê¸° ì¤‘..."
sleep 30

# Consulì—ì„œ ì„œë¹„ìŠ¤ í™•ì¸
curl http://localhost:8500/v1/catalog/service/hello-service | jq

# í—¬ìŠ¤ì²´í¬ í™•ì¸
curl http://localhost:8500/v1/health/service/hello-service?passing | jq
```

---

## âœ… **5ë‹¨ê³„: ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸**

### **5-1. ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ ì ê²€**
```bash
# Zero-Downtime ì‹œìŠ¤í…œ ìƒíƒœ
./toggle_version_consul_true_zero_downtime.sh status

# ì˜ˆìƒ ê²°ê³¼:
# [INFO] ğŸ”µ Active ì„œë¹„ìŠ¤ë“¤ (í˜„ì¬ íŠ¸ë˜í”½ ì²˜ë¦¬ ì¤‘):
# [SUCCESS]   âœ… 127.0.0.1:xxxxx (v1) [_nomad-task-...-hello-service-http]
# [INFO] âšª Standby ì„œë¹„ìŠ¤ë“¤ (ëŒ€ê¸° ì¤‘):
# [INFO]   â¸ï¸  127.0.0.1:xxxxx (v3) [_nomad-task-...-hello-service-http]
```
---

## ğŸ§ª **6ë‹¨ê³„: ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸**

### **6-1. ë¶€í•˜ í…ŒìŠ¤íŠ¸**
```bash
# k6 ê¸°ë³¸ í…ŒìŠ¤íŠ¸ (ì½˜ì†” ì¶œë ¥ + íŒŒì¼ ì €ì¥)
k6 run k6-quick-test.js 2>&1 | tee k6-console-log.txt

# ì„±ê³µ ê¸°ì¤€: 200 OK ì‘ë‹µ, 0% ì—ëŸ¬ìœ¨
# ë¡œê·¸ íŒŒì¼ í™•ì¸: cat k6-console-log.txt
```

### **6-2. ë°°í¬ í…ŒìŠ¤íŠ¸**
```bash
# ìƒˆ ë²„ì „ standby ë°°í¬ í…ŒìŠ¤íŠ¸ (v4ê°€ ìˆë‹¤ë©´)
./toggle_version_consul_true_zero_downtime.sh deploy v4

# ìƒíƒœ í™•ì¸
./toggle_version_consul_true_zero_downtime.sh status
```

### **6-3. ë¬´ì¤‘ë‹¨ ì „í™˜ í…ŒìŠ¤íŠ¸**
```bash
# ë°±ê·¸ë¼ìš´ë“œì—ì„œ k6 ì‹¤í–‰
k6 run k6-test.js &

# Zero-Downtime ì „í™˜ ì‹¤í–‰
./toggle_version_consul_true_zero_downtime.sh switch

# k6 ê²°ê³¼ í™•ì¸ - ì¤‘ë‹¨ ì—†ì´ ì„±ê³µí•´ì•¼ í•¨
```

---

## ğŸš¨ **ë¬¸ì œí•´ê²° ê°€ì´ë“œ**

### **âŒ IP ì£¼ì†Œ ë³€ê²½ ì‹œ**
```bash
# 1. ìƒˆ IP í™•ì¸
ip addr show

# 2. ëª¨ë“  ì„œë¹„ìŠ¤ ì¤‘ì§€
sudo pkill consul
sudo pkill nomad

# 3. ìƒˆ IPë¡œ ì¬ì‹œì‘
consul agent -dev -bind=ìƒˆë¡œìš´IP -client=0.0.0.0  # í„°ë¯¸ë„ 1
nomad agent -dev -bind=ìƒˆë¡œìš´IP                   # í„°ë¯¸ë„ 2

# 4. ì„œë¹„ìŠ¤ ì¬ë°°í¬
nomad job run hello-service-dynamic.nomad
```

### **âŒ ì„œë¹„ìŠ¤ ì‘ë‹µ ì—†ì„ ë•Œ**
```bash
# Docker ì»¨í…Œì´ë„ˆ í™•ì¸
docker ps -a

# Nomad í• ë‹¹ ìƒíƒœ í™•ì¸
nomad status hello-service-dynamic

# íŠ¹ì • í• ë‹¹ ë¡œê·¸ í™•ì¸
nomad logs <allocation-id>

# Consul ì„œë¹„ìŠ¤ ë“±ë¡ í™•ì¸
curl http://localhost:8500/v1/catalog/service/hello-service
```

### **âŒ nginx-auto-reload ë¬¸ì œ**
```bash
# í”„ë¡œì„¸ìŠ¤ í™•ì¸
ps aux | grep nginx-auto-reload

# ì¬ì‹œì‘
pkill -f nginx-auto-reload
./nginx-auto-reload.sh &

# ë¡œê·¸ í™•ì¸
tail -f /var/log/nginx/error.log
```

### **âŒ Load Balancer 503 ì—ëŸ¬**
```bash
# nginx ì„¤ì • í™•ì¸
sudo nginx -t

# upstream ì„œë²„ í™•ì¸
curl http://localhost:8500/v1/catalog/service/hello-service?tag=active

# ìˆ˜ë™ìœ¼ë¡œ nginx ì„¤ì • ì—…ë°ì´íŠ¸
./toggle_version.sh auto  # ì„ì‹œ í•´ê²°ì±…
```

---

## âœ… **ì‹œì‘ ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸**

### **ì¸í”„ë¼ ì„œë¹„ìŠ¤**
- [ ] Docker Desktop ì‹¤í–‰ë¨
- [ ] Consul ì„œë²„ (localhost:8500) ì‘ë‹µ
- [ ] Nomad ì„œë²„ (localhost:4646) ì‘ë‹µ
- [ ] Nginx ì„œë²„ ì‹¤í–‰ ì¤‘
- [ ] nginx-auto-reload.sh ì‹¤í–‰ ì¤‘

### **ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤**  
- [ ] hello-service ë°°í¬ ì™„ë£Œ
- [ ] Consulì— ì„œë¹„ìŠ¤ ë“±ë¡ë¨ (active/standby íƒœê·¸)
- [ ] Load Balancer (localhost:8080) ì‘ë‹µ
- [ ] ê°œë³„ ì„œë¹„ìŠ¤ í¬íŠ¸ ì‘ë‹µ

### **ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸**
- [ ] k6 í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] deploy ê¸°ëŠ¥ ì •ìƒ
- [ ] switch ê¸°ëŠ¥ ì •ìƒ (Zero-Downtime)
- [ ] ìƒíƒœ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ ì •ìƒ

---

## ğŸ¯ **ìì£¼ ì‚¬ìš©í•˜ëŠ” ëª…ë ¹ì–´ ëª¨ìŒ**

### **ë¹ ë¥¸ ìƒíƒœ í™•ì¸**
```bash
# ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ
./toggle_version_consul_true_zero_downtime.sh status

# ë¶€í•˜ í…ŒìŠ¤íŠ¸
k6 run k6-quick-test.js
```

### **ê¸´ê¸‰ ë³µêµ¬**
```bash
# ì „ì²´ ì‹œìŠ¤í…œ ì¬ì‹œì‘
nomad job stop hello-service-dynamic
sleep 10
nomad job run hello-service-dynamic.nomad

# ë°±ì—…ì—ì„œ ë³µêµ¬
cp hello-service-dynamic.nomad.backup.* hello-service-dynamic.nomad
nomad job run hello-service-dynamic.nomad

# nginx ì„¤ì • ë³µêµ¬
sudo systemctl restart nginx
```

### **ë¡œê·¸ í™•ì¸**
```bash
# Nomad ë¡œê·¸
nomad logs -job hello-service-dynamic

# Consul ë¡œê·¸  
consul monitor

# Nginx ë¡œê·¸
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

---

## ğŸ“Š **ì„±ëŠ¥ ëª©í‘œ**

- **ê°€ìš©ì„±**: 99.9% ì´ìƒ
- **ì‘ë‹µ ì‹œê°„**: í‰ê·  < 100ms
- **ë°°í¬ ì‹œê°„**: < 30ì´ˆ (standby êµì²´)
- **ì „í™˜ ì‹œê°„**: < 5ì´ˆ (Zero-Downtime switch)
- **ë¡¤ë°± ì‹œê°„**: < 5ì´ˆ

---

## ğŸ’¡ **ìš´ì˜ íŒ**

1. **í„°ë¯¸ë„ ê´€ë¦¬**: ê° ì„œë¹„ìŠ¤ë³„ë¡œ ë³„ë„ í„°ë¯¸ë„ ì‚¬ìš© ê¶Œì¥
2. **ë¡œê·¸ ëª¨ë‹ˆí„°ë§**: ê° ì„œë¹„ìŠ¤ ë¡œê·¸ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸
3. **ì •ê¸°ì  ë°±ì—…**: ì¤‘ìš”í•œ ì„¤ì • íŒŒì¼ë“¤ ì •ê¸° ë°±ì—…
4. **ë¶€í•˜ í…ŒìŠ¤íŠ¸**: ë°°í¬ ì „í›„ ë°˜ë“œì‹œ k6 í…ŒìŠ¤íŠ¸ ì‹¤í–‰
5. **ì ì§„ì  ì ìš©**: ìƒˆ ê¸°ëŠ¥ì€ standbyì—ì„œ ì¶©ë¶„íˆ í…ŒìŠ¤íŠ¸ í›„ ì „í™˜

---

**ğŸ¯ ì´ ê°€ì´ë“œë¥¼ ë”°ë¼í•˜ë©´ ì–¸ì œë“ ì§€ ì™„ì „í•œ Zero-Downtime ë°°í¬ ì‹œìŠ¤í…œì„ ë³µêµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!**

**ì‘ì„±ì¼**: $(date '+%Y-%m-%d %H:%M:%S')  
**ë²„ì „**: 1.0  
**ì‹œìŠ¤í…œ**: Nomad + Consul + Docker + Nginx