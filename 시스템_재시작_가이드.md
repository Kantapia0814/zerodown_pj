# 🚀 Zero-Downtime 배포 시스템 재시작 가이드

컴퓨터 재부팅 후 전체 무중단 배포 시스템을 다시 시작하는 완전한 단계별 가이드입니다.

## 📋 **시스템 구성 요소**

- **Docker**: 컨테이너 런타임
- **Consul**: 서비스 디스커버리 & KV 스토어
- **Nomad**: 오케스트레이션 플랫폼
- **Nginx**: Load Balancer & API Gateway
- **nginx-auto-reload**: 동적 라우팅 자동화
- **hello-service**: 마이크로서비스 (v1, v2, v3, v4...)

---

## 🔧 **1단계: 기본 환경 준비**

### **1-1. Docker Desktop 실행**
```bash
# Windows/Mac: Docker Desktop 앱 실행 후 완전히 로딩될 때까지 대기

# 상태 확인
docker --version
docker ps

# 결과 예시:
# CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES
```

### **1-2. 네트워크 IP 확인**
```bash
# IP 주소 확인 (Linux/WSL)
ip addr show

# 또는 (Windows)
ipconfig

# 주 네트워크 인터페이스의 IP 주소 기록
# 예시: eth0 -> 172.17.187.181
# 이 IP를 이후 단계에서 사용
```

---

## 🏗️ **2단계: 인프라 서비스 시작**

### **2-1. Consul 서버 시작** 
```bash
# 터미널 1 (Consul 전용)
consul agent -dev -bind=172.17.187.181 -client=0.0.0.0

# 실행 후 다음과 같은 메시지 확인:
# ==> Consul agent running!
# ==> Log data will now stream in as it occurs:
```

```bash
# 확인 (별도 터미널에서)
curl http://localhost:8500/v1/status/leader

# 정상 결과: "172.17.187.181:8300"
```

### **2-2. Nomad 서버 시작**
```bash
# 터미널 2 (Nomad 전용) 
nomad agent -dev -bind=172.17.187.181

# 실행 후 다음과 같은 메시지 확인:
# ==> Nomad agent started! Log data will stream in below:
# ==> Nomad agent configuration:
```

### **2-3. Nomad CLI 환경변수 설정**
```bash
# Nomad CLI가 올바른 서버에 연결하도록 환경변수 설정
export NOMAD_ADDR="http://172.17.187.181:4646"
```

```bash
# 확인 (별도 터미널에서)
nomad status
curl http://localhost:4646/v1/status/leader

# 정상 결과: "172.17.187.181:4647"
```

---

## 🎯 **3단계: Load Balancer 설정**

### **3-1. Nginx 상태 확인 및 시작**
```bash
# nginx 상태 확인
sudo systemctl status nginx

# nginx 시작 (중지된 경우)
sudo systemctl start nginx

# 부팅 시 자동 시작 설정
sudo systemctl enable nginx
```

### **3-2. Nginx 설정 파일 문제 해결**
```bash
# 현재 설정 파일 확인
cat /etc/nginx/conf.d/hello-service.conf

# upstream 블록이 비어있는 경우 임시 서버 추가
sudo sed -i 's/upstream hello_backend {/upstream hello_backend {\n    server 127.0.0.1:8081;/' /etc/nginx/conf.d/hello-service.conf
sudo sed -i 's/upstream hello_backend_standby {/upstream hello_backend_standby {\n    server 127.0.0.1:8082;/' /etc/nginx/conf.d/hello-service.conf

# Nginx 재시작
sudo systemctl start nginx

# 설정 확인
sudo nginx -t
```

### **3-2. consul-template 실행**
```bash
# consul-template 실행 (백그라운드)
consul-template \
  -template="nginx-configs/hello-service.ctmpl:/etc/nginx/conf.d/hello-service.conf:echo 'Config updated'" \
  -consul-addr="127.0.0.1:8500" &

# 또는 별도 터미널에서 실행
# 터미널 3 (consul-template 전용)
consul-template \
  -template="nginx-configs/hello-service.ctmpl:/etc/nginx/conf.d/hello-service.conf:echo 'Config updated'" \
  -consul-addr="127.0.0.1:8500"
```

### **3-3. nginx-auto-reload.sh 실행**
```bash
# nginx 자동 리로드 스크립트 시작 (백그라운드)
./nginx-auto-reload.sh &

# 또는 별도 터미널에서 실행
# 터미널 4 (nginx-auto-reload 전용)
./nginx-auto-reload.sh
```

---

## 🚢 **4단계: 서비스 배포**

### **4-1. hello-service 배포**
```bash
# Nomad CLI가 올바른 서버에 연결하도록 환경변수 설정
export NOMAD_ADDR="http://172.17.187.181:4646"

# 프로젝트 디렉토리 확인
cd /mnt/c/Users/hongs/IdeaProjects/kantapia_pj

# nomad 파일 상태 확인
cat hello-service-dynamic.nomad | grep -E "(image|tags|version)" 

# nomad 파일 배포
nomad job run hello-service-dynamic.nomad

# 배포 확인
nomad status hello-service-dynamic
```

### **4-2. 서비스 등록 대기 (중요!)**
```bash
# 서비스가 Consul에 등록될 때까지 대기 (약 30초-1분)
echo "서비스 등록 대기 중..."
sleep 30

# Consul에서 서비스 확인
curl http://localhost:8500/v1/catalog/service/hello-service | jq

# 헬스체크 확인
curl http://localhost:8500/v1/health/service/hello-service?passing | jq
```

---

## ✅ **5단계: 시스템 상태 확인**

### **5-1. 전체 시스템 상태 점검**
```bash
# Zero-Downtime 시스템 상태
./toggle_version_consul_true_zero_downtime.sh status

# 예상 결과:
# [INFO] 🔵 Active 서비스들 (현재 트래픽 처리 중):
# [SUCCESS]   ✅ 127.0.0.1:xxxxx (v1) [_nomad-task-...-hello-service-http]
# [INFO] ⚪ Standby 서비스들 (대기 중):
# [INFO]   ⏸️  127.0.0.1:xxxxx (v3) [_nomad-task-...-hello-service-http]
```
---

## 🧪 **6단계: 기능 테스트**

### **6-1. 부하 테스트**
```bash
# k6 기본 테스트 (콘솔 출력 + 파일 저장)
k6 run k6-quick-test.js 2>&1 | tee k6-console-log.txt

# 성공 기준: 200 OK 응답, 0% 에러율
# 로그 파일 확인: cat k6-console-log.txt
```

### **6-2. 배포 테스트**
```bash
# 새 버전 standby 배포 테스트 (v4가 있다면)
./toggle_version_consul_true_zero_downtime.sh deploy v4

# 상태 확인
./toggle_version_consul_true_zero_downtime.sh status
```

### **6-3. 무중단 전환 테스트**
```bash
# 백그라운드에서 k6 실행
k6 run k6-test.js &

# Zero-Downtime 전환 실행
./toggle_version_consul_true_zero_downtime.sh switch

# k6 결과 확인 - 중단 없이 성공해야 함
```

---

## 🚨 **문제해결 가이드**

### **❌ IP 주소 변경 시**
```bash
# 1. 새 IP 확인
ip addr show

# 2. 모든 서비스 중지
sudo pkill consul
sudo pkill nomad

# 3. 새 IP로 재시작
consul agent -dev -bind=새로운IP -client=0.0.0.0  # 터미널 1
nomad agent -dev -bind=새로운IP                   # 터미널 2

# 4. 서비스 재배포
nomad job run hello-service-dynamic.nomad
```

### **❌ 서비스 응답 없을 때**
```bash
# Docker 컨테이너 확인
docker ps -a

# Nomad 할당 상태 확인
nomad status hello-service-dynamic

# 특정 할당 로그 확인
nomad logs <allocation-id>

# Consul 서비스 등록 확인
curl http://localhost:8500/v1/catalog/service/hello-service
```

### **❌ nginx-auto-reload 문제**
```bash
# 프로세스 확인
ps aux | grep nginx-auto-reload

# 재시작
pkill -f nginx-auto-reload
./nginx-auto-reload.sh &

# 로그 확인
tail -f /var/log/nginx/error.log
```

### **❌ Load Balancer 503 에러**
```bash
# nginx 설정 확인
sudo nginx -t

# upstream 서버 확인
curl http://localhost:8500/v1/catalog/service/hello-service?tag=active

# 수동으로 nginx 설정 업데이트
./toggle_version.sh auto  # 임시 해결책
```

---

## ✅ **시작 완료 체크리스트**

### **인프라 서비스**
- [ ] Docker Desktop 실행됨
- [ ] Consul 서버 (localhost:8500) 응답
- [ ] Nomad 서버 (localhost:4646) 응답
- [ ] Nginx 서버 실행 중
- [ ] nginx-auto-reload.sh 실행 중

### **애플리케이션 서비스**  
- [ ] hello-service 배포 완료
- [ ] Consul에 서비스 등록됨 (active/standby 태그)
- [ ] Load Balancer (localhost:8080) 응답
- [ ] 개별 서비스 포트 응답

### **기능 테스트**
- [ ] k6 테스트 통과
- [ ] deploy 기능 정상
- [ ] switch 기능 정상 (Zero-Downtime)
- [ ] 상태 확인 스크립트 정상

---

## 🎯 **자주 사용하는 명령어 모음**

### **빠른 상태 확인**
```bash
# 전체 시스템 상태
./toggle_version_consul_true_zero_downtime.sh status

# 부하 테스트
k6 run k6-quick-test.js
```

### **긴급 복구**
```bash
# 전체 시스템 재시작
nomad job stop hello-service-dynamic
sleep 10
nomad job run hello-service-dynamic.nomad

# 백업에서 복구
cp hello-service-dynamic.nomad.backup.* hello-service-dynamic.nomad
nomad job run hello-service-dynamic.nomad

# nginx 설정 복구
sudo systemctl restart nginx
```

### **로그 확인**
```bash
# Nomad 로그
nomad logs -job hello-service-dynamic

# Consul 로그  
consul monitor

# Nginx 로그
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

---

## 📊 **성능 목표**

- **가용성**: 99.9% 이상
- **응답 시간**: 평균 < 100ms
- **배포 시간**: < 30초 (standby 교체)
- **전환 시간**: < 5초 (Zero-Downtime switch)
- **롤백 시간**: < 5초

---

## 💡 **운영 팁**

1. **터미널 관리**: 각 서비스별로 별도 터미널 사용 권장
2. **로그 모니터링**: 각 서비스 로그를 실시간으로 확인
3. **정기적 백업**: 중요한 설정 파일들 정기 백업
4. **부하 테스트**: 배포 전후 반드시 k6 테스트 실행
5. **점진적 적용**: 새 기능은 standby에서 충분히 테스트 후 전환

---

**🎯 이 가이드를 따라하면 언제든지 완전한 Zero-Downtime 배포 시스템을 복구할 수 있습니다!**

**작성일**: $(date '+%Y-%m-%d %H:%M:%S')  
**버전**: 1.0  
**시스템**: Nomad + Consul + Docker + Nginx